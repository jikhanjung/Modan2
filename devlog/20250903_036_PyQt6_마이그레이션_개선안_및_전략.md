# PyQt6 마이그레이션 개선안 및 실행 전략

## 개요
이 문서는 기존 PyQt6 마이그레이션 계획(20250903_035)을 보완하고, 현재 프로젝트 상황을 고려한 실용적인 개선안을 제시합니다.

## 현재 프로젝트 분석 결과

### PyQt5 사용 현황
- **총 50개 파일**에서 PyQt5 import 사용 (164개 occurrence)
- **Qt enum 사용**: 166개 (주로 5개 핵심 파일에 집중)
- **opencv-python 통합**: ModanComponents.py, ModanDialogs.py 등 5개 파일
- **deprecated API 사용**: exec_() 메서드 10개 파일에서 발견

### 주요 리스크 요인
1. **cv2 통합 부분**: 이미지 처리 로직과 PyQt6 호환성 검증 필요
2. **3D 렌더링**: 최근 완료한 QOpenGLWidget 마이그레이션 안정성
3. **대량의 enum 사용**: 166개의 Qt enum 변경 필요

## QOpenGLWidget 안정화 체크리스트

### 안정화의 구체적 의미
QOpenGLWidget 마이그레이션 안정화란 다음 항목들이 검증된 상태를 의미합니다:

#### 1. **기능적 안정성** (1-2주 모니터링)
- [ ] 3D 뷰어 크래시 없이 100회 이상 실행/종료
- [ ] 대용량 3D 모델(10만+ vertices) 로딩 테스트
- [ ] 장시간(2시간+) 연속 사용 시 메모리 누수 없음
- [ ] 다양한 파일 형식(OBJ, PLY, STL) 정상 렌더링

#### 2. **플랫폼별 검증**
- [ ] Windows 10/11에서 ANGLE 폴백 정상 동작
- [ ] Linux에서 Mesa/NVIDIA 드라이버 모두 지원
- [ ] macOS에서 Metal 백엔드 정상 동작
- [ ] 가상머신(VMware, VirtualBox)에서 Software 렌더링

#### 3. **성능 지표**
- [ ] 프레임레이트: 최소 30 FPS 유지
- [ ] 초기 로딩 시간: 5초 이내
- [ ] GPU 메모리 사용량: 500MB 이하
- [ ] CPU 사용률: 유휴 시 5% 이하

#### 4. **사용자 피드백**
- [ ] 최소 10명 이상의 사용자 테스트
- [ ] 크래시 리포트 0건 (1주일 기준)
- [ ] 렌더링 관련 이슈 해결 완료

## 개선된 마이그레이션 전략

### Phase 0: 사전 준비 (1주)

#### 자동 변환 스크립트 개발
```python
# pyqt5_to_pyqt6_converter.py
import os
import re
from pathlib import Path

class PyQt6Migrator:
    def __init__(self):
        self.enum_mappings = {
            r'Qt\.AlignCenter': 'Qt.AlignmentFlag.AlignCenter',
            r'Qt\.AlignLeft': 'Qt.AlignmentFlag.AlignLeft',
            r'Qt\.AlignRight': 'Qt.AlignmentFlag.AlignRight',
            r'Qt\.AlignTop': 'Qt.AlignmentFlag.AlignTop',
            r'Qt\.AlignBottom': 'Qt.AlignmentFlag.AlignBottom',
            r'Qt\.KeepAspectRatio': 'Qt.AspectRatioMode.KeepAspectRatio',
            r'Qt\.IgnoreAspectRatio': 'Qt.AspectRatioMode.IgnoreAspectRatio',
            r'Qt\.Key_([A-Z]\w*)': r'Qt.Key.Key_\1',
            r'Qt\.LeftButton': 'Qt.MouseButton.LeftButton',
            r'Qt\.RightButton': 'Qt.MouseButton.RightButton',
            r'Qt\.MidButton': 'Qt.MouseButton.MiddleButton',
            r'Qt\.NoModifier': 'Qt.KeyboardModifier.NoModifier',
            r'Qt\.ShiftModifier': 'Qt.KeyboardModifier.ShiftModifier',
            r'Qt\.ControlModifier': 'Qt.KeyboardModifier.ControlModifier',
        }
        
        self.import_mappings = {
            r'from PyQt5': 'from PyQt6',
            r'import PyQt5': 'import PyQt6',
        }
        
        self.method_mappings = {
            r'\.exec_\(\)': '.exec()',
            r'QDesktopWidget': 'QScreen',
            r'desktop\(\)\.': 'primaryScreen().',
        }
    
    def convert_file(self, filepath):
        """Convert a single Python file"""
        # Implementation details...
        pass
    
    def validate_conversion(self, filepath):
        """Validate the converted file"""
        # Check syntax, run basic tests
        pass
    
    def create_backup(self, filepath):
        """Create backup before conversion"""
        # Save original file with .bak extension
        pass
```

### Phase 1: 호환성 레이어 구축 (1주)

#### 듀얼 지원 래퍼 작성
```python
# qt_compat.py
"""PyQt5/PyQt6 호환성 레이어"""

try:
    from PyQt6 import QtCore, QtGui, QtWidgets
    from PyQt6.QtCore import Qt
    PYQT6 = True
    
    # PyQt6 enum 래퍼
    AlignCenter = Qt.AlignmentFlag.AlignCenter
    KeepAspectRatio = Qt.AspectRatioMode.KeepAspectRatio
    
except ImportError:
    from PyQt5 import QtCore, QtGui, QtWidgets
    from PyQt5.QtCore import Qt
    PYQT6 = False
    
    # PyQt5 enum 유지
    AlignCenter = Qt.AlignCenter
    KeepAspectRatio = Qt.KeepAspectRatio

# 공통 인터페이스
def exec_dialog(dialog):
    """PyQt5/6 호환 dialog 실행"""
    if PYQT6:
        return dialog.exec()
    else:
        return dialog.exec_()
```

### Phase 2: 점진적 마이그레이션 (2-3주)

#### 우선순위별 모듈 변환
1. **Low Risk** (1주차)
   - MdUtils.py (유틸리티, Qt 의존성 낮음)
   - MdStatistics.py (계산 로직 중심)
   - MdModel.py (데이터베이스 레이어)

2. **Medium Risk** (2주차)
   - MdHelpers.py (Qt 헬퍼 함수들)
   - ModanController.py (비즈니스 로직)
   - MdSplashScreen.py (독립적 UI)

3. **High Risk** (3주차)
   - ModanComponents.py (cv2 통합, QOpenGLWidget)
   - ModanDialogs.py (복잡한 UI, cv2 사용)
   - Modan2.py (메인 애플리케이션)

### Phase 3: 통합 테스트 (1주)

#### 테스트 매트릭스
| 테스트 영역 | PyQt5 | PyQt6 | 비교 지표 |
|------------|-------|-------|----------|
| 3D 렌더링 성능 | Baseline | Target | FPS, 메모리 |
| 이미지 처리 (cv2) | Baseline | Target | 처리 시간 |
| UI 반응성 | Baseline | Target | 이벤트 지연 |
| 메모리 사용량 | Baseline | Target | Peak/Average |
| 시작 시간 | Baseline | Target | 초 단위 |

### Phase 4: 배포 준비 (1주)

#### CI/CD 파이프라인 수정
```yaml
# .github/workflows/build.yml 수정
strategy:
  matrix:
    pyqt-version: ['PyQt5', 'PyQt6']  # 병렬 빌드
    python-version: ['3.9', '3.10', '3.11', '3.12']
    os: [ubuntu-latest, windows-latest, macos-latest]
```

## 리스크 관리 계획

### 롤백 전략
1. **Git 브랜치 전략**
   ```bash
   main (stable PyQt5)
   ├── feature/qopengl-stable (안정화 작업)
   └── feature/pyqt6-migration (PyQt6 작업)
       └── feature/pyqt6-compat (호환성 레이어)
   ```

2. **체크포인트 시스템**
   - 각 Phase 완료 시 태그 생성
   - 문제 발생 시 이전 체크포인트로 복원

### 의존성 충돌 해결

#### 알려진 충돌 및 해결책
| 패키지 | PyQt5 버전 | PyQt6 대안 | 해결 방법 |
|--------|-----------|-----------|----------|
| opencv-python | 4.x | 4.8+ | 버전 업그레이드 |
| matplotlib | 3.x | 3.5+ | backend 설정 변경 |
| PyOpenGL | 3.1.x | 3.1.6+ | 동일 버전 사용 가능 |

### 성능 저하 대응

#### 모니터링 지표
```python
# performance_monitor.py
class PerformanceMonitor:
    def __init__(self):
        self.metrics = {
            'render_time': [],
            'memory_usage': [],
            'cpu_usage': [],
            'gpu_usage': [],
        }
    
    def measure_3d_performance(self):
        """3D 렌더링 성능 측정"""
        # FPS, 렌더링 시간, GPU 사용률
        pass
    
    def measure_ui_responsiveness(self):
        """UI 반응성 측정"""
        # 이벤트 처리 시간, 입력 지연
        pass
    
    def generate_report(self):
        """성능 비교 리포트 생성"""
        # PyQt5 vs PyQt6 비교 차트
        pass
```

## 커뮤니케이션 계획

### 사용자 알림
1. **마이그레이션 시작 공지**
   - 예상 일정 및 영향
   - 베타 테스트 참여 요청

2. **진행 상황 업데이트**
   - 주간 진행 리포트
   - 이슈 트래커 공개

3. **완료 후 가이드**
   - 변경사항 요약
   - 트러블슈팅 가이드

## 성공 지표

### 정량적 지표
- [ ] 모든 자동화 테스트 통과 (100%)
- [ ] 성능 저하 5% 이내
- [ ] 메모리 사용량 증가 10% 이내
- [ ] 크래시 발생률 0.1% 미만

### 정성적 지표
- [ ] 사용자 만족도 조사 (긍정 80% 이상)
- [ ] 개발팀 피드백 (유지보수성 향상)
- [ ] 커뮤니티 반응 (이슈 감소)

## 타임라인

### 2025년 9월 - 10월 계획
```
9월 1-2주: QOpenGLWidget 안정화 모니터링
9월 3주: PyQt6 사전 준비 및 스크립트 개발
9월 4주: 호환성 레이어 구축
10월 1-2주: 점진적 마이그레이션
10월 3주: 통합 테스트
10월 4주: 배포 준비 및 문서화
```

## 결론
PyQt6 마이그레이션은 필요하지만, 현재 완료한 QOpenGLWidget 마이그레이션의 안정성을 먼저 확보해야 합니다. 제안된 개선안은 리스크를 최소화하면서 점진적으로 마이그레이션을 수행할 수 있는 실용적인 접근법을 제공합니다.

---
*작성일: 2025년 9월 3일*
*작성자: Modan2 개발팀*
*상태: 제안*