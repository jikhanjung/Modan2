# Phase 2 시작 보고서

**작성일**: 2025-10-05
**Phase**: 2 - Architecture & Design
**목표**: 아키텍처 개선 및 파일 분할
**예상 기간**: 1개월

---

## 📋 Phase 2 개요

### 목표
1. **ModanDialogs.py 분할** (7,653 lines → 7+ files)
2. **ModanComponents.py 분할** (4,852 lines → 4+ packages)
3. **MVC 패턴 강화**
4. **테스트 커버리지 향상** (69% → 75%)

### 현재 상태

#### 파일 크기 분석
| 파일 | 현재 크기 | 문제점 |
|------|----------|--------|
| ModanDialogs.py | 7,653 lines | 너무 큼 |
| ModanComponents.py | 4,852 lines | 너무 큼 |
| **합계** | **12,505 lines** | 유지보수 어려움 |

#### ModanDialogs.py 클래스 분석

| 클래스 | 시작 라인 | 크기 | 우선순위 |
|--------|----------|------|---------|
| DatasetOpsViewer | 173 | 122 lines | 🟢 낮음 |
| PicButton | 295 | 37 lines | 🟢 낮음 |
| **ProgressDialog** | **332** | **47 lines** | ✅ **완료** |
| CalibrationDialog | 379 | 87 lines | 🟡 중간 |
| DatasetDialog | 466 | 380 lines | 🟡 중간 |
| **ObjectDialog** | **846** | **1,175 lines** | 🔴 **높음** |
| NewAnalysisDialog | 2,021 | 321 lines | 🟡 중간 |
| AnalysisResultDialog | 2,342 | 46 lines | 🟢 낮음 |
| **DataExplorationDialog** | **2,388** | **2,600 lines** | 🔴 **최우선** |
| **DatasetAnalysisDialog** | **4,988** | **1,306 lines** | 🔴 **높음** |
| ExportDatasetDialog | 6,294 | 328 lines | 🟡 중간 |
| ImportDatasetDialog | 6,622 | 364 lines | 🟡 중간 |
| PreferencesDialog | 6,986 | 668 lines | 🟡 중간 |

**총 13개 클래스, 7,653 lines**

---

## ✅ 완료된 작업

### 1. 기반 구조 생성

#### 1.1 `dialogs/` 디렉토리 생성 ✅
```
dialogs/
├── __init__.py              # 패키지 초기화 및 re-export
├── base_dialog.py           # BaseDialog 기본 클래스
└── progress_dialog.py       # ProgressDialog (첫 번째 분리 완료)
```

#### 1.2 `BaseDialog` 클래스 생성 ✅
**파일**: `dialogs/base_dialog.py` (120 lines)

**제공 기능**:
- ✅ Error/Warning/Info 메시지 표시
- ✅ Progress bar 관리
- ✅ Wait cursor 관리
- ✅ 표준 OK/Cancel 버튼 레이아웃
- ✅ Type hints 및 docstring 완비

**예시**:
```python
class BaseDialog(QDialog):
    """Base class for all Modan2 dialogs."""

    def show_error(self, message: str, title: str = "Error") -> None:
        """Display error message dialog."""
        QMessageBox.critical(self, title, message)
        logger.error(f"{title}: {message}")

    def with_wait_cursor(self, func: Callable) -> object:
        """Execute function with wait cursor."""
        QApplication.setOverrideCursor(Qt.WaitCursor)
        try:
            return func()
        finally:
            QApplication.restoreOverrideCursor()
```

#### 1.3 첫 번째 Dialog 분리 완료: ProgressDialog ✅
**파일**: `dialogs/progress_dialog.py` (77 lines)

**변경사항**:
- ✅ BaseDialog 상속
- ✅ Type hints 추가
- ✅ Docstring 추가
- ✅ 코드 정리

---

## 📊 현재 진행 상황

### 완료율
- **Phase 2 전체**: ~2% 완료
- **ModanDialogs 분할**: 1/13 클래스 완료 (7.7%)
- **ModanComponents 분할**: 0% (아직 시작 안 함)

### 완료된 항목
- ✅ `dialogs/` 디렉토리 생성
- ✅ `BaseDialog` 클래스 구현
- ✅ `ProgressDialog` 분리 완료
- ✅ `dialogs/__init__.py` 작성 (임시 re-export)

---

## 🎯 다음 단계 (우선순위순)

### 1단계: 작은 Dialog부터 분리 (1주)
**목표**: 코드 구조 검증, 패턴 확립

- [ ] CalibrationDialog (87 lines)
- [ ] AnalysisResultDialog (46 lines)
- [ ] DatasetOpsViewer (122 lines)
- [ ] PicButton (37 lines)

**예상 시간**: 4-6시간

### 2단계: 중간 크기 Dialog 분리 (1주)
- [ ] NewAnalysisDialog (321 lines)
- [ ] ExportDatasetDialog (328 lines)
- [ ] ImportDatasetDialog (364 lines)
- [ ] DatasetDialog (380 lines)

**예상 시간**: 8-12시간

### 3단계: 큰 Dialog 분리 (2주)
**가장 어려운 작업**

#### 3.1 PreferencesDialog (668 lines)
- [ ] 설정 UI 분리
- [ ] 테스트 작성

#### 3.2 ObjectDialog (1,175 lines)
- [ ] 객체 편집 UI
- [ ] 랜드마크 테이블
- [ ] 이미지 뷰어 통합

#### 3.3 DatasetAnalysisDialog (1,306 lines)
- [ ] 분석 관리 UI
- [ ] 결과 표시

#### 3.4 DataExplorationDialog (2,600 lines) 🔴 **최대 난이도**
**문제점**: 단일 클래스가 너무 큼

**해결 방안**:
```
dialogs/data_exploration/
├── __init__.py
├── main_dialog.py         # 메인 다이얼로그 (800 lines)
├── plot_manager.py        # 플롯 관리 (800 lines)
├── data_table.py          # 데이터 테이블 (600 lines)
└── export_manager.py      # 내보내기 (400 lines)
```

**예상 시간**: 20-30시간

---

## 🔧 전략 및 원칙

### 1. 점진적 마이그레이션
```python
# dialogs/__init__.py (현재)
# 기존 ModanDialogs에서 임시 re-export
from ModanDialogs import DataExplorationDialog  # 아직 분리 안 됨

# 분리 완료 후
from dialogs.data_exploration import DataExplorationDialog  # 새 위치
```

**장점**:
- 기존 import 구문 변경 최소화
- 점진적 테스트 가능
- 롤백 용이

### 2. BaseDialog 상속 원칙
모든 새 dialog는 `BaseDialog` 상속:
```python
from dialogs.base_dialog import BaseDialog

class NewDialog(BaseDialog):
    def __init__(self, parent=None):
        super().__init__(parent, title="New Dialog")
        # ...
```

### 3. Type Hints 및 Docstring 추가
분리 시 반드시 추가:
```python
def some_method(self, param: str) -> bool:
    """Method description.

    Args:
        param: Parameter description

    Returns:
        Return value description
    """
    pass
```

### 4. 테스트 작성
각 분리된 dialog에 대해 테스트 작성:
```python
# tests/dialogs/test_progress_dialog.py
def test_progress_dialog_initialization(qtbot):
    """Test ProgressDialog initializes correctly."""
    dialog = ProgressDialog(None)
    assert dialog.stop_progress is False
```

---

## ⚠️ 알려진 위험 및 대응

### 위험 1: Import 순환 참조
**문제**: Dialog들이 서로 참조하는 경우

**대응**:
- Import를 함수 내부로 이동 (lazy import)
- 의존성 다이어그램 작성
- Controller를 통한 의존성 주입

### 위험 2: 대규모 파일 분리 시 버그
**문제**: 2,600줄짜리 DataExplorationDialog 분리 시 실수 가능

**대응**:
- 작은 dialog부터 시작해 패턴 확립
- 각 단계마다 테스트 실행
- Git branch로 작업, PR로 리뷰

### 위험 3: 시간 부족
**문제**: 1개월 내 완료 어려움

**대응**:
- 우선순위 기반 작업 (큰 dialog 먼저)
- 필요시 Phase 3로 일부 이연
- 주간 진행 상황 리뷰

---

## 📈 성공 기준

### Phase 2 완료 조건
1. ✅ 모든 dialog가 `dialogs/` 패키지로 이동
2. ✅ `ModanDialogs.py` 삭제 (또는 deprecated)
3. ✅ 모든 dialog가 `BaseDialog` 상속
4. ✅ 각 파일 < 1,000 lines (큰 dialog는 sub-package로 분할)
5. ✅ 모든 테스트 통과
6. ✅ 테스트 커버리지 75%+
7. ✅ 문서 업데이트 (CLAUDE.md, ARCHITECTURE.md)

---

## 📅 예상 일정

| 주차 | 작업 | 목표 |
|------|------|------|
| **1주** | 작은 dialog 분리 | 4개 dialog 완료 |
| **2주** | 중간 dialog 분리 | 4개 dialog 완료 |
| **3주** | 큰 dialog 분리 (Part 1) | ObjectDialog, DatasetAnalysisDialog |
| **4주** | 큰 dialog 분리 (Part 2) | DataExplorationDialog, 테스트, 문서 |

---

## 💡 교훈 (Phase 1에서)

### 적용할 점
1. ✅ Pre-commit hooks로 코드 품질 자동 검증
2. ✅ Ruff로 자동 포맷팅
3. ✅ 작은 단위로 커밋
4. ✅ 테스트 먼저 실행

### 개선할 점
1. ⚠️ 더 작은 단위로 작업 분할
2. ⚠️ 진행 상황 정기 문서화
3. ⚠️ 테스트 커버리지 목표 현실적으로 설정

---

## 📎 참고 자료

- [Phase 2 Roadmap](./20251005_078_improvement_roadmap_phase2.md)
- [Phase 1 Completion Report](./20251005_082_phase1_completion.md)
- [BaseDialog Implementation](../dialogs/base_dialog.py)
- [ProgressDialog Implementation](../dialogs/progress_dialog.py)

---

**Status**: 🚀 Phase 2 시작
**진행률**: 2% 완료
**다음 작업**: 작은 dialog 분리 계속 진행
**Last Updated**: 2025-10-05
