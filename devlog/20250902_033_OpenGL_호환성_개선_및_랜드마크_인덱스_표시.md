# OpenGL 호환성 개선 및 랜드마크 인덱스 표시 구현

## 작업 날짜
2025년 9월 2일

## 작업 배경
GitHub Actions에서 빌드된 Windows 실행 파일이 OpenGL 관련 크래시를 일으키는 문제가 지속되었다. 주요 원인은:
1. 구버전 PyOpenGL wheel 파일과 numpy 2.x의 ABI 불일치
2. GLUT 의존성으로 인한 Windows 배포 환경 크래시
3. 랜드마크 인덱스 표시 기능이 GLUT에 의존하여 비활성화됨

## 해결 과정

### 1. PyOpenGL Wheel 파일 문제 해결

#### 문제 상황
- Repository에 포함된 PyOpenGL wheel 파일들이 numpy 1.x로 빌드되어 numpy 2.x와 호환 불가
- "numpy.dtype size changed" 에러 발생
- Windows 빌드에서만 requirements_win.txt 사용으로 인한 일관성 문제

#### 해결 방법
1. GitHub Actions를 requirements.txt로 통일
```yaml
# .github/workflows/build.yml
- name: Install Windows dependencies
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt  # requirements_win.txt → requirements.txt
    pip install pyinstaller
```

2. 구버전 wheel 파일 제거
```bash
# 제거된 파일들:
- PyOpenGL-3.1.6-cp310-cp310-win_amd64.whl
- PyOpenGL-3.1.7-cp312-cp312-win_amd64.whl
- PyOpenGL_accelerate-3.1.6-cp310-cp310-win_amd64.whl
- PyOpenGL_accelerate-3.1.7-cp312-cp312-win_amd64.whl
```

### 2. OpenGL 안정성 개선

#### OpenGL 정보 로깅 추가
```python
# ModanComponents.py - initializeGL()
from PyQt5.QtGui import QOpenGLContext
v  = gl.glGetString(gl.GL_VERSION) or b""
vr = gl.glGetString(gl.GL_RENDERER) or b""
vd = gl.glGetString(gl.GL_VENDOR) or b""
fmt = QOpenGLContext.currentContext().format()

logger.info(
    "OpenGL init | VER=%s | RENDERER=%s | VENDOR=%s | fmt=%s.%s %s depth=%d stencil=%d samples=%d",
    v.decode(errors="ignore"), vr.decode(errors="ignore"), vd.decode(errors="ignore"),
    fmt.majorVersion(), fmt.minorVersion(),
    "Core" if fmt.profile()==fmt.CoreProfile else "Compat",
    fmt.depthBufferSize(), fmt.stencilBufferSize(), fmt.samples()
)
```

#### OpenGL 백엔드 설정 조정
```python
# main.py
if getattr(sys, 'frozen', False):  # PyInstaller builds
    if "QT_OPENGL" not in os.environ:
        # ANGLE provides better compatibility on Windows
        os.environ["QT_OPENGL"] = "angle"  # desktop → angle
```

#### Width/Height 가드 추가
```python
# ModanComponents.py - resizeGL()
width = max(1, width)   # Prevent division by zero
height = max(1, height)
self.aspect = width / float(height)

# paintGL()
if self.width() <= 0 or self.height() <= 0:
    return  # Skip rendering for invalid sizes
```

### 3. CI/CD OpenGL Smoke Test 추가

새로운 테스트 파일 `test_opengl_smoke.py` 생성:
- OpenGL/PyQt5 모듈 import 테스트
- Offscreen OpenGL context 생성 테스트
- 모든 플랫폼 빌드에 추가 (continue-on-error)

```yaml
# .github/workflows/build.yml
- name: Run OpenGL smoke test
  run: |
    python test_opengl_smoke.py
  continue-on-error: true
```

### 4. 랜드마크 인덱스 표시 구현 (QPainter 오버레이)

#### 기존 문제
- GLUT 텍스트 렌더링 의존성으로 인해 비활성화됨
- Windows 배포 환경에서 GLUT 크래시 위험

#### 새로운 구현 방식
QPainter 오버레이를 사용한 안전한 텍스트 렌더링:

```python
# ModanComponents.py
def draw_object(self, ...):
    # 3D 랜드마크 렌더링 후 2D 투영
    if self.show_index:
        modelview = gl.glGetDoublev(gl.GL_MODELVIEW_MATRIX)
        projection = gl.glGetDoublev(gl.GL_PROJECTION_MATRIX)
        viewport = gl.glGetIntegerv(gl.GL_VIEWPORT)
        
        # 3D → 2D 스크린 좌표 변환
        x, y, z = glu.gluProject(lm[0], lm[1], lm[2], modelview, projection, viewport)
        if 0 <= x <= viewport[2] and 0 <= y <= viewport[3]:
            self.landmark_screen_positions.append((x, viewport[3] - y, i + 1))

def draw_landmark_indices_overlay(self):
    """QPainter를 사용한 인덱스 오버레이"""
    painter = QPainter(self)
    painter.setRenderHint(QPainter.TextAntialiasing)
    
    font = QFont("Arial", 10, QFont.Bold)
    painter.setFont(font)
    
    for x, y, index in self.landmark_screen_positions:
        # 검은색 외곽선 (가독성 향상)
        painter.setPen(QPen(QColor(0, 0, 0), 3))
        for dx, dy in [(-1,-1), (-1,0), (-1,1), (0,-1), (0,1), (1,-1), (1,0), (1,1)]:
            painter.drawText(QPoint(int(x + dx + 5), int(y + dy - 5)), str(index))
        
        # 흰색 텍스트
        painter.setPen(QPen(QColor(255, 255, 255), 1))
        painter.drawText(QPoint(int(x + 5), int(y - 5)), str(index))
```

## 주요 개선사항

### 1. 의존성 관리
- ✅ numpy 2.x 호환성 문제 해결
- ✅ PyOpenGL을 PyPI에서 직접 설치
- ✅ 모든 플랫폼에서 동일한 requirements.txt 사용

### 2. OpenGL 안정성
- ✅ ANGLE 백엔드 사용으로 Windows 호환성 개선
- ✅ OpenGL 정보 로깅으로 디버깅 용이성 향상
- ✅ Width/Height 가드로 division by zero 방지
- ✅ CI/CD에서 OpenGL 테스트로 조기 문제 발견

### 3. 기능 개선
- ✅ 랜드마크 인덱스 표시 기능 복원
- ✅ GLUT 의존성 제거로 안정성 향상
- ✅ QPainter 사용으로 더 나은 텍스트 품질
- ✅ 한글 지원 가능 (Qt 폰트 렌더링)

## 기술적 이점

### QPainter 오버레이 방식의 장점
1. **호환성**: ANGLE, Desktop GL, Software 렌더러 모두 지원
2. **품질**: Qt의 고품질 폰트 렌더링 활용
3. **안정성**: OpenGL 컨텍스트와 독립적
4. **유연성**: 폰트, 색상, 크기 쉽게 조정 가능
5. **국제화**: 유니코드 및 한글 완벽 지원

### 성능 최적화
- 화면에 보이는 랜드마크만 처리
- 매 프레임 landmark_screen_positions 초기화
- gluProject()로 효율적인 3D→2D 변환

## 테스트 확인 사항

### 로컬 테스트
- [x] 프로그램 정상 실행
- [x] 3D 뷰어 정상 작동
- [x] 랜드마크 인덱스 표시
- [x] 다양한 각도에서 인덱스 가독성

### CI/CD 테스트
- [x] GitHub Actions 빌드 성공
- [x] OpenGL smoke test 실행
- [x] 모든 플랫폼 artifact 생성

## 향후 개선 사항

1. **선택적 표시**: 사용자가 인덱스 표시 on/off 토글 가능하도록 UI 추가
2. **크기 조정**: DPI 스케일링 대응 (devicePixelRatioF() 활용)
3. **성능 최적화**: 많은 랜드마크 처리 시 QStaticText 캐싱 고려
4. **깊이 테스트**: glReadPixels로 가려진 랜드마크 인덱스 숨기기

## 관련 커밋
- `26dee29`: GitHub Actions를 requirements.txt로 통일
- `9ad25d6`: 구버전 PyOpenGL wheel 파일 제거
- `292cae4`: OpenGL 안정성 개선 (로깅, ANGLE, 가드)
- `cb52a4a`: QPainter 오버레이로 랜드마크 인덱스 표시 구현

## 결론
오늘의 작업으로 Modan2의 배포 안정성이 크게 향상되었다. numpy 2.x 호환성 문제를 해결하고, GLUT 의존성을 제거하며, QPainter 기반의 안전한 텍스트 렌더링을 구현했다. 이제 GitHub Actions에서 빌드된 실행 파일도 안정적으로 작동할 것으로 기대된다.