# 자동화된 테스트 도입 계획 검토 및 개선사항

## 검토 일자: 2025-08-28

## 1. 기존 계획의 장점

### 잘 구성된 부분
1. **단계적 접근 방식**
   - UI를 제외하고 순수 함수부터 시작하는 전략이 현실적이고 효율적임
   - 테스트 작성의 진입 장벽을 낮추는 좋은 접근

2. **적절한 우선순위 설정**
   - MdUtils.py → MdModel.py → 비즈니스 로직 순서가 논리적임
   - 독립적인 컴포넌트부터 시작하여 점진적으로 복잡도를 높이는 전략

3. **테스트 격리**
   - 메모리 내 SQLite DB 사용으로 실제 데이터베이스와 격리
   - 테스트 속도 향상과 안전성 확보

## 2. 개선 제안사항

### 2.1 프로젝트 문서 업데이트

**CLAUDE.md에 테스트 섹션 추가 필요:**
```markdown
### Testing
- Framework: pytest
- Run all tests: `pytest`
- Run with coverage: `pytest --cov=. --cov-report=html`
- Test directory: `tests/`
- Install test dependencies: `pip install -r config/requirements-dev.txt`
- Test before commit: Always run `pytest` before committing changes
```

### 2.2 개발 의존성 확장

**requirements-dev.txt 권장 구성:**
```txt
pytest==8.3.3           # 핵심 테스트 프레임워크
pytest-cov==5.0.0       # 코드 커버리지 측정
pytest-mock==3.14.0     # Mock 기능 강화
pytest-qt==4.4.0        # PyQt5 UI 테스트 (추후 도입용)
pytest-xvfb==3.0.0      # Headless 환경에서 GUI 테스트 (CI/CD용)
```

### 2.3 실용적인 첫 테스트 예시

Mock 대신 실제 유틸리티 함수부터 테스트 시작:

```python
# tests/test_mdutils.py
import sys
import os
import pytest

# 프로젝트 루트를 Python 경로에 추가
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from MdUtils import get_icon_path, resource_path, PROGRAM_NAME, VERSION

def test_program_constants():
    """프로그램 상수값 검증"""
    assert PROGRAM_NAME == "Modan2"
    assert VERSION is not None
    assert len(VERSION.split('.')) == 3  # x.y.z 형식

def test_resource_path():
    """리소스 경로 생성 함수 테스트"""
    path = resource_path('icons/Modan2.png')
    assert path is not None
    assert 'icons' in path

def test_get_icon_path():
    """아이콘 경로 함수 테스트"""
    # 실제 구현에 따라 조정 필요
    icon_path = get_icon_path('Modan2')
    assert icon_path is not None
```

### 2.4 데이터베이스 모델 테스트 구조

```python
# tests/test_models.py
import pytest
import tempfile
from peewee import SqliteDatabase
from MdModel import MdDataset, MdObject, database_proxy

@pytest.fixture
def test_db():
    """테스트용 임시 데이터베이스 fixture"""
    with tempfile.NamedTemporaryFile(suffix='.db') as tmp:
        test_database = SqliteDatabase(tmp.name)
        database_proxy.initialize(test_database)

        # 테이블 생성
        test_database.create_tables([MdDataset, MdObject])

        yield test_database

        # 정리
        test_database.drop_tables([MdDataset, MdObject])
        test_database.close()

def test_create_dataset(test_db):
    """데이터셋 생성 테스트"""
    dataset = MdDataset.create(
        dataset_name="Test Dataset",
        dataset_desc="Test Description"
    )
    assert dataset.id is not None
    assert dataset.dataset_name == "Test Dataset"
```

### 2.5 CI/CD 파이프라인 구성

**`.github/workflows/test.yml` 파일 생성:**
```yaml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libgl1-mesa-glx

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install -r config/requirements-dev.txt

    - name: Run tests with coverage
      run: |
        xvfb-run -a pytest --cov=. --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
```

### 2.6 테스트 데이터 관리 구조

```
tests/
├── fixtures/
│   ├── sample_data.tps      # 샘플 TPS 파일
│   ├── sample_data.nts      # 샘플 NTS 파일
│   ├── sample_model.obj     # 샘플 3D 모델
│   └── sample_image.jpg     # 샘플 이미지
├── test_mdutils.py
├── test_models.py
├── test_statistics.py
└── conftest.py              # pytest 공통 fixture 정의
```

### 2.7 테스트 실행 명령어 확장

```bash
# 기본 테스트 실행
pytest

# 상세 출력과 함께 실행
pytest -v

# 특정 파일만 테스트
pytest tests/test_mdutils.py

# 커버리지 측정과 함께 실행
pytest --cov=. --cov-report=html

# 실패한 테스트만 재실행
pytest --lf

# 병렬 실행 (pytest-xdist 필요)
pytest -n auto
```

## 3. 단계별 구현 로드맵

### Phase 1 (Week 1)
- [x] requirements-dev.txt 생성
- [ ] tests/ 디렉토리 구조 설정
- [ ] MdUtils.py 테스트 작성 (목표 커버리지: 80%)
- [ ] 기본 pytest 설정 (pytest.ini)

### Phase 2 (Week 2)
- [ ] MdModel.py 테스트 작성
- [ ] 테스트 fixture 데이터 준비
- [ ] MdStatistics.py 핵심 함수 테스트

### Phase 3 (Week 3)
- [ ] 비즈니스 로직 통합 테스트
- [ ] CI/CD 파이프라인 구성
- [ ] 커버리지 목표 설정 (전체 50% 이상)

### Phase 4 (추후)
- [ ] pytest-qt를 활용한 UI 컴포넌트 테스트
- [ ] 성능 테스트 추가
- [ ] 회귀 테스트 자동화

## 4. 예상 효과

1. **코드 품질 향상**: 버그 조기 발견 및 수정
2. **리팩토링 안정성**: 테스트가 안전망 역할
3. **문서화 효과**: 테스트 코드가 사용 예시 역할
4. **협업 효율성**: PR 시 자동 테스트로 품질 보증
5. **배포 신뢰성**: 테스트 통과 후 배포로 안정성 확보

## 5. 주의사항

- OpenCV(cv2) 관련 테스트는 headless 환경 설정 필요
- PyQt5 GUI 테스트는 Xvfb 필요 (CI/CD 환경)
- 테스트 실행 시간을 3분 이내로 유지
- Mock은 최소화하고 실제 코드 테스트 우선

## 6. 결론

제안된 테스트 도입 계획은 프로젝트의 현재 상태와 목표를 고려할 때 매우 적절합니다.
위의 개선사항들을 반영하면 더욱 견고한 테스트 인프라를 구축할 수 있을 것입니다.
특히 점진적 접근과 우선순위 설정이 현실적이며, 이를 통해 Modan2 프로젝트의
장기적인 유지보수성과 안정성을 크게 향상시킬 수 있을 것으로 기대됩니다.
